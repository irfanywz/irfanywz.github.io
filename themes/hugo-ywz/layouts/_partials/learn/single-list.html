{{ if .IsSection }}
    {{ $split := "/"}}
    {{ if strings.Contains .File.Dir "\\" }}
        {{ $split = "\\"}}
    {{ end }}
    {{ $dirParts := split .File.Dir $split }}

    <!-- when accessing section redirect to parent -->

    {{ if (eq (len $dirParts) 4) }}
        {{ with .Parent }}
            <meta http-equiv="refresh" content="0; url={{ .RelPermalink }}" />
        {{ end }}
    {{ end }}
{{ end }}

<main class="flex-grow bg-white dark:bg-gray-900 transition-colors duration-300" 
    x-data="{ 
        sidebarOpen: false,
        activeSection: '',
        init() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.activeSection = entry.target.id;
                    }
                });
            }, { rootMargin: '-100px 0px -60% 0px' });
            
            document.querySelectorAll('.prose h2[id], .prose h3[id], .prose h4[id]').forEach(section => {
                observer.observe(section);
            });

            this.$watch('activeSection', (id) => {
                if(id) {
                    // Scroll sidebar link into view
                    const activeLink = document.querySelector(`aside a[href='#${id}']`);
                    if(activeLink) {
                        activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                }
            });

            // Scroll to active sidebar item on load
            this.$nextTick(() => {
                const sidebar = document.querySelector('aside > div');
                const activeItem = sidebar.querySelector('a.bg-indigo-50, a.dark\\:bg-indigo-900\\/30');
                if (sidebar && activeItem) {
                    const top = activeItem.offsetTop - sidebar.offsetTop - (sidebar.clientHeight / 2) + (activeItem.clientHeight / 2);
                    sidebar.scrollTo({ top: top, behavior: 'smooth' });
                }
            });            
        }
    }">    

    <section class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30 lg:static">
        <div class="container-fluid px-4 py-3">
            <nav class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 overflow-hidden">
                    {{ with .Parent }}
                    <a href="{{ .RelPermalink }}" class="flex items-center gap-1 flex-shrink-0 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
                        <i class="icon-[ri--lightbulb-line] text-sky-500 align-bottom"></i>
                        {{ .Title }}
                    </a>
                    {{ end }}
                    <i class="icon-[ri--arrow-right-s-line] flex-shrink-0"></i>
                    <span class="font-medium text-gray-900 dark:text-white truncate">{{ .Title }}</span>
                </div>
                
                <button @click="sidebarOpen = !sidebarOpen" class="lg:hidden p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="icon-[ri--menu-line]"></i>
                </button>
            </nav>
        </div>
    </section>

    <!-- Main Container -->
    <div class="flex flex-col lg:flex-row min-h-[calc(100vh-7rem)]">
        <!-- Sidebar -->
        <aside class="lg:w-72 flex-shrink-0 border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 lg:block lg:sticky lg:top-0 lg:h-[calc(100vh)]"
               :class="sidebarOpen ? 'fixed inset-y-0 left-0 z-100 w-72 shadow-2xl' : 'hidden'">
            <div class="h-full overflow-y-auto p-4">
                 <div class="flex items-center justify-between lg:hidden mb-4">
                    <h2 class="font-bold text-gray-900 dark:text-white">Menu</h2>
                    <button @click="sidebarOpen = false" class="p-2 text-gray-500"><i class="icon-[ri--close-line]"></i></button>
                </div>
                {{ partial "learn/single-list-sidebar.html" . }}
            </div>
        </aside>
        
        <!-- Backdrop -->
        <div x-show="sidebarOpen" x-transition.opacity class="fixed inset-0 bg-black/50 z-90 lg:hidden" @click="sidebarOpen = false" style="display: none;"></div>

        <!-- Content Wrapper -->
        <div class="flex-grow min-w-0 flex flex-col lg:flex-row">
            <!-- Main Content -->
            <main class="flex-grow p-6 lg:p-10 min-w-0">
                <div class="mb-8 border-b border-gray-200 dark:border-gray-700 pb-6">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                        {{ .Title }}
                    </h1>
                </div>

                <div class="prose prose-lg dark:prose-invert max-w-none mb-12">
                    {{ with .Content }}
                    {{ . | safeHTML }}
                    {{ end }}
                </div>

                <!-- Navigation Between Submodules -->
                {{ $sortedPosts := sort .Data.Pages "Weight" }}
                {{ $first := first 1 $sortedPosts}}
                {{ if $first }}
                    <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
                        {{ range $first }}
                            {{ $targetPage := . }}
                            {{ if .IsSection }}
                                {{ $subPages := sort .Pages "Weight" }}
                                {{ if gt (len $subPages) 0 }}
                                    {{ $targetPage = index $subPages 0 }}
                                {{ end }}
                            {{ end }}
                            <a href="{{ $targetPage.RelPermalink }}" class="flex items-center justify-between p-6 rounded-xl bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-900/50 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-all group">
                                <div>
                                    <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider mb-1 block">Mulai Belajar</span>
                                    <span class="text-lg font-bold text-gray-900 dark:text-white">
                                    {{ if $targetPage.Params.section }}
                                        {{ $targetPage.Params.section }}
                                    {{ else }}
                                        {{ $targetPage.Title }}
                                    {{ end }}
                                    </span>
                                </div>
                                <div class="w-10 h-10 bg-white dark:bg-gray-800 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 shadow-sm group-hover:scale-110 transition-transform">
                                    <i class="icon-[ri--arrow-right-line] text-xl"></i>
                                </div>
                            </a>
                        {{ end }}
                    </div>
                {{ end }}

            </main>
            
             <!-- TOC (Right Sidebar) -->
            <aside class="hidden xl:block w-64 flex-shrink-0 p-6 border-l border-gray-200 dark:border-gray-700">
                <div class="sticky top-32">
                    {{ partial "learn/toc.html" . }}
                </div>
            </aside>
        </div>
    </div>
</main>