{{ define "head" }}
{{ end }}

{{ define "main" }}
    <main class="flex-grow bg-white dark:bg-gray-900 transition-colors duration-300"
        x-data="{
            search: new URLSearchParams(window.location.search).get('search') || '',
            category: new URLSearchParams(window.location.search).get('category') || 'all',
            view: new URLSearchParams(window.location.search).get('view') || 'list',
            sidebarOpen: false,
            
            updateUrl() {
                const url = new URL(window.location);
                if (this.search) url.searchParams.set('search', this.search);
                else url.searchParams.delete('search');
                
                if (this.category !== 'all') url.searchParams.set('category', this.category);
                else url.searchParams.delete('category');
                
                if (this.view !== 'list') url.searchParams.set('view', this.view);
                else url.searchParams.delete('view');
                
                window.history.pushState({}, '', url);
            },
            
            setCategory(cat) {
                this.category = cat;
                this.updateUrl();
                if (window.innerWidth < 1024) this.sidebarOpen = false;
            },
            
            setView(v) {
                this.view = v;
                this.updateUrl();
            },

            clearFilters() {
                this.search = '';
                this.category = 'all';
                this.updateUrl();
            },

            copyPrompt(text, $el) {
                // Simple copy logic
                navigator.clipboard.writeText(text).then(() => {
                    const originalHTML = $el.innerHTML;
                    $el.innerHTML = '<i class=\'icon-[ri--check-line]\'></i>';
                    setTimeout(() => { $el.innerHTML = originalHTML; }, 1500);
                });
            },
            
            items: [
                {{ range .Pages }}
                {
                    categories: {{ .Params.categories | default (slice) | jsonify }},
                    title: {{ .Title | lower | jsonify }},
                    content: {{ .Plain | lower | jsonify }}
                },
                {{ end }}
            ],
            
            get hasResults() {
                const s = this.search.toLowerCase();
                return this.items.some(i => {
                    return (this.category === 'all' || i.categories.includes(this.category)) && 
                           (this.search === '' || i.title.includes(s) || i.content.includes(s));
                });
            }
        }"
        @popstate.window="
            search = new URLSearchParams(window.location.search).get('search') || '';
            category = new URLSearchParams(window.location.search).get('category') || 'all';
            view = new URLSearchParams(window.location.search).get('view') || 'list';
        "
    >

        <div class="bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-700 py-8">
            <div class="container max-w-6xl mx-auto px-4">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2 flex items-center gap-3">
                    <span class="icon-[ri--magic-line] w-8 h-8 text-fuchsia-500"></span>
                    {{ .Title }}
                </h1>
                <p class="text-gray-600 dark:text-gray-300">{{ .Description }}</p>
            </div>
        </div>
        
        {{ if .Pages }}
        <div class="container max-w-6xl mx-auto px-4 py-8">
            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- Mobile Sidebar Toggle -->
                <button @click="sidebarOpen = !sidebarOpen" class="lg:hidden w-full flex items-center justify-between px-4 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm text-gray-700 dark:text-gray-200 font-medium mb-4">
                    <span>Kategori</span>
                    <i class="icon-[ri--arrow-down-s-line] transition-transform duration-200" :class="sidebarOpen ? 'rotate-180' : ''"></i>
                </button>

                <!-- Sidebar -->
                <aside class="lg:w-64 flex-shrink-0" :class="sidebarOpen ? 'block' : 'hidden lg:block'">
                    <div class="sticky top-24 space-y-6">
                        <div>
                            <h3 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider mb-4 px-2">Kategori</h3>
                            <nav class="space-y-1">
                                <button @click="setCategory('all')" 
                                    :class="category === 'all' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800'"
                                    class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                    <span>Semua</span>
                                    <span class="bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 py-0.5 px-2 rounded-full text-xs">{{ len .Pages }}</span>
                                </button>

                                {{/* Group categories logic */}}
                                {{ $groupedCategories := dict }}
                                {{ range .Pages }}
                                    {{ $normalizedPath := replace .File.Dir "\\" "/" }}
                                    {{ $pathParts := split $normalizedPath "/" }}
                                    {{ $group := "Lainnya" }}
                                    {{ if gt (len $pathParts) 1 }}
                                        {{ $group = index $pathParts 1 | humanize | title }}
                                    {{ end }}
                                    {{ $pageCategories := .Params.categories | default (slice) }}
                                    {{ if not (reflect.IsSlice $pageCategories) }}{{ $pageCategories = slice $pageCategories }}{{ end }}
                                    {{ $existingCategories := index $groupedCategories $group | default (slice) }}
                                    {{ $allCatsForGroup := $existingCategories | append $pageCategories | uniq }}
                                    {{ $groupedCategories = merge $groupedCategories (dict $group $allCatsForGroup) }}
                                {{ end }}

                                {{ range $group, $categories := $groupedCategories }}
                                    <div class="pt-4" x-data="{ open: true }">
                                        <button @click="open = !open" class="w-full flex items-center justify-between px-2 py-1 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-gray-200">
                                            <span>{{ $group }}</span>
                                            <i class="icon-[ri--arrow-down-s-line] transition-transform duration-200" :class="open ? '' : '-rotate-90'"></i>
                                        </button>
                                        <div x-show="open" x-collapse class="mt-1 space-y-1">
                                            {{ range sort $categories }}
                                                {{ $cat := . }}
                                                <button @click='setCategory({{ $cat | jsonify }})'
                                                    :class='category === {{ $cat | jsonify }} ? "bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400" : "text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800"'
                                                    class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                                    <span>{{ $cat }}</span>
                                                    {{ $count := len (where $.Site.RegularPages.ByDate.Reverse "Params.categories" "intersect" (slice $cat)) }}
                                                    <span class="bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 py-0.5 px-2 rounded-full text-xs">{{ $count }}</span>
                                                </button>
                                            {{ end }}
                                        </div>
                                    </div>
                                {{ end }}
                            </nav>
                        </div>
                    </div>
                </aside>

                <!-- Content -->
                <div class="flex-grow min-w-0">
                    
                    <!-- Toolbar -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <div class="relative flex-grow">
                            <i class="icon-[ri--search-line] absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="search" x-model="search" @input.debounce.300ms="updateUrl()" placeholder="Cari prompt..." 
                                class="w-full pl-10 pr-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all">
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <div class="flex bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-1">
                                <button @click="setView('list')" :class="view === 'list' ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'" class="p-2 rounded transition-colors flex" title="List View">
                                    <i class="icon-[ri--list-check]"></i>
                                </button>
                                <button @click="setView('grid')" :class="view === 'grid' ? 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'" class="p-2 rounded transition-colors flex" title="Grid View">
                                    <i class="icon-[ri--layout-grid-line]"></i>
                                </button>
                            </div>
                            <button x-show="search !== '' || category !== 'all'" @click="clearFilters()" class="px-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium flex items-center gap-2">
                                <i class="icon-[ri--close-line]"></i> Hapus
                            </button>
                        </div>
                    </div>

                    <!-- Grid/List -->
                    <div :class="view === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 gap-6' : 'space-y-6'">
                        {{ range .Pages }}
                        <article 
                            x-show='(category === "all" || {{ .Params.categories | default (slice) | jsonify }}.includes(category)) && (search === "" || {{ .Title | lower | jsonify }}.includes(search.toLowerCase()) || {{ .Plain | lower | jsonify }}.includes(search.toLowerCase()))'
                            class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-all duration-300 flex flex-col"
                        >
                            <div class="p-5 flex-grow" :class="view === 'list' ? 'flex flex-col md:flex-row gap-6' : 'flex flex-col gap-4'">
                                {{ with .Params.image }}
                                <div class="flex-shrink-0 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center" :class="view === 'list' ? 'w-full md:w-48 h-48' : 'w-full h-48'">
                                    <img src="{{ . | relURL }}" alt="{{ $.Title }}" class="max-w-full max-h-full object-contain p-2">
                                </div>
                                {{ end }}
                                
                                <div class="flex-grow min-w-0 flex flex-col">
                                    <div class="relative bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-100 dark:border-gray-700 p-4 font-mono text-sm text-gray-600 dark:text-gray-300 overflow-y-auto max-h-48 mb-4">
                                        <code class="whitespace-pre-wrap break-words">{{ .Content | safeHTML }}</code>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="px-5 py-3 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700 flex items-center justify-between">
                                <div>
                                    <h2 class="font-semibold text-gray-900 dark:text-white text-sm">{{ .Title }}</h2>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ .Date | time.Format "2 January 2006" }}</p>
                                </div>
                                <button @click="copyPrompt({{ .Plain | jsonify }}, $el)" class="p-2 text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-white dark:hover:bg-gray-700 rounded-lg transition-all" title="Salin Prompt">
                                    <i class="icon-[ri--file-copy-line] text-lg"></i>
                                </button>
                            </div>
                        </article>
                        {{ end }}
                        
                        <div x-show="!hasResults" x-transition class="col-span-full text-center py-12" style="display: none;">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-800 mb-4">
                                <i class="icon-[ri--search-2-line] text-2xl text-gray-400"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-1">Tidak ditemukan</h3>
                            <p class="text-gray-500 dark:text-gray-400">Coba kata kunci atau kategori lain.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        {{ else }}
        <div class="container max-w-6xl mx-auto px-4 py-16 text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-indigo-50 dark:bg-indigo-900/30 mb-6">
                <span class="text-4xl">ðŸ’¡</span>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Belum Ada Prompt</h2>
            <p class="text-gray-600 dark:text-gray-300 max-w-md mx-auto">Saat ini belum ada prompt yang tersedia. Silakan tambahkan file markdown baru di dalam direktori content/bank-prompt/ untuk memulai.</p>
        </div>
        {{ end }}
    </main>
{{ end }}

{{ define "footer" }}
{{ end }}